---
name: 'Checkout Repositories'
description: 'Checkout repositories (Local & helm-chart-app-values) for ArgoCD deployment.'

inputs:
  app_name:
    description: 'Name of the app to deploy.'
    required: true
    type: string
  github_token_checkout:
    description: 'The GitHub token to checkout helm_chart_template repository.'
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v3

    - run: |
        export COMMIT_TIME=$( git show -s --format=%ct )
        if [[ '${{ github.event_name }}' == 'pull_request' ]]; then
          export BRANCH_NAME_LOCAL=$( echo $GITHUB_HEAD_REF )
        elif [[ '${{ github.event_name }}' == 'push' ]]; then
          export BRANCH_NAME_LOCAL=$( echo $GITHUB_REF )
        else
          exit 1
        fi
        echo "BRANCH_NAME=$( echo $BRANCH_NAME_LOCAL )" >> $GITHUB_ENV

        echo "The Branch name is: ${{ env.BRANCH_NAME }}"
        echo "The Trigger is: ${{ github.event_name }}"

        echo "CURRENT_ENV=$( cut -d '-' -f 1 <<< "$BRANCH_NAME_LOCAL" )" >> $GITHUB_ENV
        echo "TIME=$( date -d@$COMMIT_TIME -u +"%Y-%m-%dT%H%M")" >> $GITHUB_ENV
        echo "SHORT_SHA=$( git rev-parse --short=7 HEAD )" >> $GITHUB_ENV
      shell: bash

    - uses: actions/checkout@v3
      if: env.BRANCH_NAME == 'master' || env.BRANCH_NAME == 'main'
      with:
        repository: fcm-digital/helm-chart-${{ inputs.app_name }}-values
        token: ${{ inputs.github_token_checkout }}
        ref: ${{ env.BRANCH_NAME }}
        path: helm-chart-${{ inputs.app_name }}-values-prod

    - uses: actions/checkout@v3
      with:
        repository: fcm-digital/helm-chart-${{ inputs.app_name }}-values
        token: ${{ inputs.github_token_checkout }}
        ref: staging
        path: helm-chart-${{ inputs.app_name }}-values-staging
