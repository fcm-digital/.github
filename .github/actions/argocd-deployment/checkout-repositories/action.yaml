---
name: "Checkout Repositories"
description: "Checkout repositories and init context variables for ArgoCD deployment."

inputs:
  app_name:
    description: "App Name to Deploy."
    required: true

  branch_name:
    description: "Branch Name to Checkout (Required for manual deploy)."
    required: false
  env_to_deploy:
    description: "Target Environment to Deploy. (Required for manual deploy)."
    required: false
  image_tag:
    description: "Image Tag to Deploy. If not provided, the image will be built from the workflow branch."
    required: false
  release_name:
    description: "Release Name to be Deployed on. (Only valid if `env_to_deploy` is `prod`)"
    required: false

  github_app_id:
    description: "The GitHub App ID."
    required: true
  github_app_private_key:
    description: "The GitHub App Private Key."
    required: true
  github_organization_name:
    description: "The GitHub Organization Name."
    required: false
    default: "fcm-digital"

outputs:
  branch_name:
    description: "The name of the branch being deployed."
    value: ${{ steps.set-outputs.outputs.branch_name }}
  env_to_deploy:
    description: "The target environment for deployment."
    value: ${{ steps.set-outputs.outputs.env_to_deploy }}
  commit_at:
    description: "The timestamp of the commit."
    value: ${{ steps.set-outputs.outputs.current_time }}
  commit:
    description: "The unique identifier for the commit."
    value: ${{ steps.set-outputs.outputs.short_sha }}
  image_tag:
    description: "The tag of the new image to be deployed."
    value: ${{ steps.set-outputs.outputs.image_tag }}

runs:
  using: "composite"
  steps:
    - id: checkout
      name: Checkout Repository
      uses: actions/checkout@v6

    - id: init-context-vars
      name: Init Context Variables
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || [[ "${{ github.event_name }}" == "workflow_run" ]]; then
          if [[ -z "${{ inputs.branch_name }}" ]]; then
            echo "# ðŸš¨ Checkout failed" > $GITHUB_STEP_SUMMARY
            echo "## Reason" >> $GITHUB_STEP_SUMMARY
            echo "Branch name not provided in a ${{ github.event_name }} event ." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            BRANCH_NAME="${{ inputs.branch_name }}"
            echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV
          fi

          if [[ -z "${{ inputs.env_to_deploy }}" ]]; then
            echo "# ðŸš¨ Checkout failed" > $GITHUB_STEP_SUMMARY
            echo "## Reason" >> $GITHUB_STEP_SUMMARY
            echo "Environment not provided in a ${{ github.event_name }} event." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "ENV_TO_DEPLOY=${{ inputs.env_to_deploy }}" >> $GITHUB_ENV
          fi

        else
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BRANCH_NAME="${{ github.head_ref }}"
            echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV

            echo "The \`env_to_deploy\` extraction from the \`branch_name\` in a PR event is no longer available."
            echo "You must use the \`argocd-get-env-to-deploy-on\` action to obtain the \`env_to_deploy\` value."
            echo "ENV_TO_DEPLOY=NOT_DEFINED" >> $GITHUB_ENV

          elif [[ "${{ github.event_name }}" == "push" ]]; then
            BRANCH_NAME="${{ github.ref_name }}"
            echo "BRANCH_NAME=${BRANCH_NAME}" >> $GITHUB_ENV

            if [[ "${{ github.ref }}" == "refs/heads/master" || "${{ github.ref }}" == "refs/heads/main" ]]; then
              echo "ENV_TO_DEPLOY=prod" >> $GITHUB_ENV
            else
              echo "ENV_TO_DEPLOY=${{ github.ref_name }}" >> $GITHUB_ENV
            fi

          else
            echo "# ðŸš¨ Checkout failed" > $GITHUB_STEP_SUMMARY
            echo "## Reason" >> $GITHUB_STEP_SUMMARY
            echo "Event \`${{ github.event_name }}\` not supported." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        fi
        # Create an output with the branch variable to use in the sanitization process'
        echo branch_name=${BRANCH_NAME} >> $GITHUB_OUTPUT
      shell: bash

    - id: sanitize-image-tag
      name: Sanitize image tag
      uses: fcm-digital/.github/.github/actions/sanitize-docker-tag@v3.2.0
      with:
        tag: ${{ steps.init-context-vars.outputs.branch_name }}

    - id: set-outputs
      name: Set Outputs
      run: |
        if [[ "${{ inputs.image_tag }}" == "master" || "${{ inputs.image_tag }}" == "latest" ]] && [[ "$ENV_TO_DEPLOY" == "prod" ]]; then
          echo "# ðŸš¨ Deployment failed" > $GITHUB_STEP_SUMMARY
          echo "## Reason" >> $GITHUB_STEP_SUMMARY
          echo "You can't deploy \`master\` or \`latest\` image on PROD" >> $GITHUB_STEP_SUMMARY
          exit 1
        elif [[ -z "${{ inputs.image_tag }}" ]]; then
          export COMMIT_TIME=$( git show -s --format=%ct )
          export CURRENT_TIME=$( date -d@$COMMIT_TIME -u +"%Y-%m-%dt%H%M" )
          export SHORT_SHA=$( git rev-parse --short=7 "$GITHUB_SHA" )
          echo "current_time=$CURRENT_TIME" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "image_tag=${{ steps.sanitize-image-tag.outputs.sanitized_tag }}-$CURRENT_TIME-$SHORT_SHA" >> $GITHUB_OUTPUT
        else
          echo "image_tag=${{ steps.sanitize-image-tag.outputs.sanitized_tag }}" >> $GITHUB_OUTPUT
        fi
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "env_to_deploy=$ENV_TO_DEPLOY" >> $GITHUB_OUTPUT
      shell: bash

    - id: app-token
      name: Create GitHub App Token
      uses: actions/create-github-app-token@v2
      with:
        app-id: ${{ inputs.github_app_id }}
        private-key: ${{ inputs.github_app_private_key }}
        owner: ${{ inputs.github_organization_name }}
        repositories: helm-chart-${{ inputs.app_name }}-values

    #! Only used by UI-KIT Repository - v2 Release (Prod)
    - id: checkout-helm-chart-values-prod-release-version
      name: Checkout helm-chart-values [Prod] - Release version
      uses: actions/checkout@v6
      if: steps.set-outputs.outputs.env_to_deploy == 'prod' && inputs.release_name != '' && github.event_name == 'workflow_dispatch'
      with:
        repository: ${{ inputs.github_organization_name }}/helm-chart-${{ inputs.app_name }}-values
        token: ${{ steps.app-token.outputs.token }}
        ref: master
        path: helm-chart-${{ inputs.app_name }}-values-prod

    - id: checkout-helm-chart-values-prod
      name: Checkout helm-chart-values [Prod]
      uses: actions/checkout@v6
      if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') &&
        (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main') &&
        steps.set-outputs.outputs.env_to_deploy == 'prod' &&
        (steps.set-outputs.outputs.branch_name == 'master' || steps.set-outputs.outputs.branch_name == 'main')
      with:
        repository: ${{ inputs.github_organization_name }}/helm-chart-${{ inputs.app_name }}-values
        token: ${{ steps.app-token.outputs.token }}
        ref: ${{ steps.init-context-vars.outputs.branch_name }}
        path: helm-chart-${{ inputs.app_name }}-values-prod

    - id: checkout-helm-chart-values-staging
      name: Checkout helm-chart-values [Staging]
      uses: actions/checkout@v6
      with:
        repository: ${{ inputs.github_organization_name }}/helm-chart-${{ inputs.app_name }}-values
        token: ${{ steps.app-token.outputs.token }}
        ref: staging
        path: helm-chart-${{ inputs.app_name }}-values-staging